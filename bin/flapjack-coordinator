#!/usr/bin/env ruby

FLAPJACK_ENV = ENV['FLAPJACK_ENV'] || 'development'
require 'bundler'
Bundler.require(:default, FLAPJACK_ENV.to_sym)

# load the config hash for the current environment
config_file = File.join('etc', 'flapjack_config.yaml')

if File.file?(config_file)
  config = YAML::load(File.open(config_file))
else
  puts "Could not find 'etc/flapjack_config.yaml'"
  exit(false)
end

config_env = config[FLAPJACK_ENV]

if config_env.nil? || config_env.empty?
  puts "No config data for environment '#{FLAPJACK_ENV}'"
  exit(false)
end

# add lib to the default include path
unless $:.include?(File.dirname(__FILE__) + '/../lib/')
  $: << File.dirname(__FILE__) + '/../lib'
end

# TODO Flapjack falls over when Redis restarted -- trap errors and attempt reconnect

require 'flapjack/coordinator'

coordinator = Flapjack::Coordinator.new(config_env)
coordinator.log_file = 'log/flapjack.log'
coordinator.pid_file = 'tmp/pids/flapjack.pid'

coordinator.start(:daemonize => true)
