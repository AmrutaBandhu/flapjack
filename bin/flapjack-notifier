#!/usr/bin/env ruby

$: << File.dirname(__FILE__) + '/../lib' unless $:.include?(File.dirname(__FILE__) + '/../lib/')

require 'rubygems'
require 'beanstalk-client'
require 'ostruct'
require 'optparse'
require 'log4r'
require 'log4r/outputter/syslogoutputter'
require 'flapjack/result'
require 'flapjack/notifier'
require 'flapjack/notifiers/mailer'
require 'flapjack/notifiers/xmpp'

# command line options are in here
require 'flapjack/cli/notifier'

# boot up the notifier
@options = Flapjack::NotifierOptions.parse(ARGV)

ncli = Flapjack::NotifierCLI.new
ncli.setup_loggers
ncli.setup_recipients(:filename => @options.recipients)

ncli.log.debug("Loading Mailer notifier")
mailer = Flapjack::Notifiers::Mailer.new
ncli.log.debug("Loading XMPP notifier")
xmpp = Flapjack::Notifiers::Xmpp.new(:jid => "flapjack-test@jabber.org", :password => "test")
ncli.log.debug("Bringing up notifier subsystem")
ncli.notifier = Notifier.new(:logger => ncli.log, 
                             :notifiers => [mailer], #, xmpp], 
                             :recipients => ncli.recipients)

begin 

  ncli.results_queue = Beanstalk::Pool.new(["#{@options.host}:11300"], 'results')
  ncli.log.info("established connection to beanstalkd on #{@options.host}...")

  # process results
  ncli.process_loop

rescue Beanstalk::NotConnected
  ncli.log.error("beanstalk isn't up!")
  exit 2
end
