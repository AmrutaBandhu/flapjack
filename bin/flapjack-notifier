#!/usr/bin/env ruby

require 'rubygems'
require 'beanstalk-client'
require 'ostruct'
require 'optparse'
require 'log4r'
require 'log4r/outputter/syslogoutputter'
require 'lib/flapjack/result'
require 'lib/flapjack/notifier'
require 'lib/flapjack/notifiers/mailer'
require 'lib/flapjack/notifiers/xmpp'
require 'lib/flapjack/cli/notifier'

@options = Flapjack::NotifierOptions.parse(ARGV)

ncli = Flapjack::NotifierCLI.new
ncli.setup_loggers
ncli.setup_recipients(:filename => File.join(File.dirname(__FILE__), "recipients.yaml"))

mailer = Flapjack::Notifiers::Mailer.new
xmpp = Flapjack::Notifiers::Xmpp.new(:jid => "flapjack-test@jabber.org", :password => "test")
ncli.notifier = Notifier.new(:logger => ncli.log, 
                             :notifiers => [mailer, xmpp], 
                             :recipients => ncli.recipients)

begin 

  ncli.results_queue = Beanstalk::Pool.new(["#{@options.host}:11300"], 'results')
  ncli.log.info("established connection to beanstalkd on #{@options.host}...")

  # process results
  ncli.process_loop

rescue Beanstalk::NotConnected
  ncli.log.error("beanstalk isn't up!")
  exit 2
end
